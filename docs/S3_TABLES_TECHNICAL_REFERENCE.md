# S3 Tables Technical Reference

## Complete API and Configuration Reference

This document provides detailed technical reference for the S3 Tables (Apache Iceberg) implementation.

## Table Schema

### Database
```
Name: pricing_intelligence_{stage}
Type: Glue Database
Location: s3://carousel-{stage}-analytics/pricing-intelligence/
Parameters:
  classification: parquet
  data_format: iceberg
```

### Table
```
Database: pricing_intelligence_{stage}
Name: sales_history
Type: EXTERNAL_TABLE (Iceberg format)
Location: s3://carousel-{stage}-analytics/pricing-intelligence/sales_history/
InputFormat: org.apache.iceberg.mr.mapreduce.IcebergInputFormat
OutputFormat: org.apache.iceberg.mr.mapreduce.IcebergOutputFormat
SerializationLibrary: org.apache.iceberg.mr.hive.HiveIcebergSerDe
```

### Column Definitions

```sql
-- Core Product Information
product_id STRING
  - Product identifier
  - Format: alphanumeric string
  - Unique per product listing
  - Example: "prod-12345-abc"

tenant_id STRING
  - Multi-tenant identifier
  - Fixed value: "carousel-labs"
  - Used for data isolation
  - Indexed in queries

category STRING
  - Product category
  - Enum values: coats, handbags, shoes, dresses, jackets, accessories, pants, sweaters
  - Normalized lowercase
  - Critical for partitioning strategy

brand STRING
  - Product brand name
  - Normalized title case
  - Examples: "Gucci", "Prada", "Louis Vuitton"
  - Can be null for generic items

condition STRING
  - Product condition at sale
  - Enum values:
    * new_with_tags: Never worn with original tags
    * new_without_tags: Never worn, no tags
    * like_new: Worn once or twice, excellent
    * very_good: Light wear, function perfect
    * good: Moderate wear, fully functional
    * fair: Visible wear, fully functional
  - Affects pricing strategy

sold_price DECIMAL(10,2)
  - Actual sale price in USD
  - Precision: 2 decimal places
  - Range: 0.01 to 9999999.99
  - Used for analytics and trending

sold_date TIMESTAMP
  - Sale completion timestamp
  - Format: ISO 8601
  - UTC timezone
  - Used for partitioning (year, month)
  - Time-series analysis

season STRING
  - Fiscal quarter of sale
  - Enum values: Q1, Q2, Q3, Q4
  - Derived from sold_date month:
    * Q1: January-March
    * Q2: April-June
    * Q3: July-September
    * Q4: October-December
  - Used for seasonal analysis

image_s3_key STRING
  - Full S3 object key to product image
  - Format: s3://bucket-name/path/to/image.jpg
  - Original image, not thumbnail
  - Can be null if image unavailable

embedding ARRAY<DOUBLE>
  - 1024-dimensional embedding vector
  - Generated by: Amazon Titan embeddings
  - Range: [-1.0, 1.0]
  - Uses: Similarity search, recommendations
  - Memory: 8KB per record
  - Can be null for compatibility

description STRING
  - Product description text
  - Freeform text
  - 100-1000 characters typically
  - Used for full-text search
  - Nullable for minimal descriptions

source STRING
  - Data source origin
  - Enum values:
    * smartgo: SmartGo API
    * carousel: Carousel platform
  - Important for data quality analysis
  - Required field
```

### Partition Keys

```sql
-- Partition Columns (Physical Partitioning)
year INT
  - Extracted from sold_date
  - Range: 2020-2030
  - Example: 2024
  - First partition level

month INT
  - Extracted from sold_date
  - Range: 1-12
  - Example: 3
  - Second partition level

-- S3 Partition Path Structure
s3://carousel-{stage}-analytics/pricing-intelligence/sales_history/
  └── year=2024/
      ├── month=01/
      │   ├── dev-sales-2024-01-000001.parquet
      │   ├── dev-sales-2024-01-000002.parquet
      │   └── ...
      ├── month=02/
      └── ...
```

## File Format Specification

### Parquet Configuration
```
Compression: SNAPPY
  - Compression ratio: 60-80%
  - CPU overhead: Low
  - Suitable for analytics

Row Group Size: Default
  - Typical: 128 MB
  - Allows efficient column pruning

Column Encoding: Plain/Dictionary
  - Adaptive encoding per column
  - Dictionary for categorical columns
  - Plain for high-cardinality data

Statistics: Enabled
  - Min/max values per column
  - Row counts
  - Used by Athena for partition pruning
```

## Iceberg Table Properties

```yaml
Table Properties:
  table_type: ICEBERG
  format: parquet
  write.parquet.compression-codec: snappy
  classification: parquet
  EXTERNAL: "TRUE"

Iceberg Metadata:
  - Version history tracked
  - Snapshot isolation for reads
  - Time-travel capability (EXPERIMENTAL)
  - Schema evolution support
```

## AWS Service Integration

### Glue Configuration

```python
import boto3

glue = boto3.client('glue', region_name='eu-west-1')

# Get database
response = glue.get_database(Name='pricing_intelligence_dev')

# Get table
response = glue.get_table(
    DatabaseName='pricing_intelligence_dev',
    Name='sales_history'
)

# List partitions
response = glue.get_partitions(
    DatabaseName='pricing_intelligence_dev',
    TableName='sales_history'
)

# Create partition
glue.batch_create_partition(
    DatabaseName='pricing_intelligence_dev',
    TableName='sales_history',
    PartitionInputList=[
        {
            'Values': ['2024', '01'],
            'StorageDescriptor': {
                'Location': 's3://carousel-dev-analytics/pricing-intelligence/sales_history/year=2024/month=01/'
            }
        }
    ]
)
```

### S3 Configuration

```
Bucket: carousel-{stage}-analytics
Versioning: Enabled
Encryption: S3-Managed (AES-256)
Public Access: Blocked

Lifecycle Rules:
  - Transition to GLACIER after 730 days
  - Expiration after 2555 days (7 years)

S3 URI Format:
  s3://carousel-{stage}-analytics/pricing-intelligence/sales_history/year=YYYY/month=MM/filename.parquet
```

### Athena Configuration

```python
import boto3

athena = boto3.client('athena', region_name='eu-west-1')

# Execute query
response = athena.start_query_execution(
    QueryString="""
        SELECT * FROM pricing_intelligence_dev.sales_history
        WHERE tenant_id = 'carousel-labs'
          AND year = 2024
          AND month >= 9
        LIMIT 1000
    """,
    QueryExecutionContext={
        'Database': 'pricing_intelligence_dev'
    },
    ResultConfiguration={
        'OutputLocation': 's3://carousel-dev-analytics/athena-results/'
    },
    WorkGroup='primary'
)

# Poll for results
query_id = response['QueryExecutionId']
execution = athena.get_query_execution(QueryExecutionId=query_id)

# Get results
results = athena.get_query_results(QueryExecutionId=query_id)
```

## SQL Query Patterns

### Partition Pruning (Recommended)
```sql
-- GOOD: Uses partition columns
SELECT * FROM pricing_intelligence_dev.sales_history
WHERE tenant_id = 'carousel-labs'
  AND year = 2024        -- Partition column
  AND month IN (9, 10)   -- Partition column
LIMIT 100;
-- Data scanned: ~1-2 GB (2 months of data)
```

### Full Table Scan (Avoid if Possible)
```sql
-- BAD: No partition filter
SELECT * FROM pricing_intelligence_dev.sales_history
WHERE category = 'handbags'
LIMIT 100;
-- Data scanned: ~100+ GB (entire table)
-- Cost: ~$0.50+ per query
```

### Column Projection
```sql
-- GOOD: Select only needed columns
SELECT product_id, brand, sold_price, sold_date
FROM pricing_intelligence_dev.sales_history
WHERE year = 2024 AND month >= 9;
-- Data scanned: ~50% of full table (columnar format)
```

### Aggregation Patterns
```sql
-- GROUP BY with filtering
SELECT
    category,
    brand,
    COUNT(*) as items_sold,
    AVG(sold_price) as avg_price,
    STDDEV(sold_price) as price_stddev
FROM pricing_intelligence_dev.sales_history
WHERE year = 2024
  AND month >= 9
  AND tenant_id = 'carousel-labs'
GROUP BY category, brand
HAVING COUNT(*) >= 5;
```

### Time Series Analysis
```sql
-- Monthly aggregation
SELECT
    year,
    month,
    COUNT(*) as monthly_sales,
    SUM(sold_price) as revenue,
    AVG(sold_price) as avg_price,
    LAG(SUM(sold_price)) OVER (ORDER BY year, month) as prev_month_revenue
FROM pricing_intelligence_dev.sales_history
WHERE tenant_id = 'carousel-labs'
GROUP BY year, month
ORDER BY year DESC, month DESC;
```

## Lambda Integration Examples

### Writing Data to Iceberg

```typescript
import * as AWS from 'aws-sdk';
import * as fs from 'fs';
import * as Papa from 'papaparse';

const s3 = new AWS.S3();
const glue = new AWS.Glue();

interface SalesRecord {
  product_id: string;
  tenant_id: string;
  category: string;
  brand: string;
  condition: string;
  sold_price: number;
  sold_date: string;
  season: string;
  image_s3_key: string;
  embedding: number[];
  description: string;
  source: string;
}

async function writeSalesDataToIceberg(
  records: SalesRecord[]
): Promise<void> {
  // Convert to CSV (Iceberg can also use Parquet)
  const csv = Papa.unparse(records);

  // Partition by year and month
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');

  // Upload to S3 in partition structure
  const key = `pricing-intelligence/sales_history/year=${year}/month=${month}/batch-${Date.now()}.csv`;

  await s3.putObject({
    Bucket: 'carousel-dev-analytics',
    Key: key,
    Body: csv,
    ContentType: 'text/csv',
    Metadata: {
      'table': 'sales_history',
      'format': 'csv',
      'records': records.length.toString()
    }
  }).promise();

  console.log(`Uploaded ${records.length} records to s3://${key}`);

  // Glue will automatically discover new partitions
}

export const handler = async (event: any) => {
  const records: SalesRecord[] = [
    {
      product_id: 'prod-001',
      tenant_id: 'carousel-labs',
      category: 'handbags',
      brand: 'Gucci',
      condition: 'like_new',
      sold_price: 1500.00,
      sold_date: new Date().toISOString(),
      season: 'Q4',
      image_s3_key: 's3://bucket/prod-001.jpg',
      embedding: new Array(1024).fill(0.5), // Placeholder
      description: 'Gucci handbag in like new condition',
      source: 'carousel'
    }
  ];

  await writeSalesDataToIceberg(records);
  return { statusCode: 200 };
};
```

### Querying Data from Iceberg

```typescript
import * as AWS from 'aws-sdk';

const athena = new AWS.Athena();

interface QueryResult {
  queryId: string;
  state: string;
  data?: Record<string, unknown>[];
}

async function querySalesHistory(
  category: string,
  minPrice: number = 0,
  maxPrice: number = 10000
): Promise<QueryResult> {
  const query = `
    SELECT
      product_id,
      brand,
      condition,
      sold_price,
      sold_date
    FROM pricing_intelligence_dev.sales_history
    WHERE tenant_id = 'carousel-labs'
      AND year = 2024
      AND category = '${category}'
      AND sold_price BETWEEN ${minPrice} AND ${maxPrice}
    ORDER BY sold_date DESC
    LIMIT 100
  `;

  const response = await athena.startQueryExecution({
    QueryString: query,
    QueryExecutionContext: {
      Database: 'pricing_intelligence_dev'
    },
    ResultConfiguration: {
      OutputLocation: 's3://carousel-dev-analytics/athena-results/'
    }
  }).promise();

  const queryId = response.QueryExecutionId!;

  // Poll for completion
  let attempts = 0;
  while (attempts < 30) {
    const status = await athena.getQueryExecution({
      QueryExecutionId: queryId
    }).promise();

    if (status.QueryExecution?.Status?.State === 'SUCCEEDED') {
      const results = await athena.getQueryResults({
        QueryExecutionId: queryId
      }).promise();

      return {
        queryId,
        state: 'SUCCEEDED',
        data: results.ResultSet?.Rows?.slice(1).map((row) => ({
          product_id: row.Data?.[0]?.VarCharValue,
          brand: row.Data?.[1]?.VarCharValue,
          condition: row.Data?.[2]?.VarCharValue,
          sold_price: parseFloat(row.Data?.[3]?.VarCharValue || '0'),
          sold_date: row.Data?.[4]?.VarCharValue
        }))
      };
    }

    if (status.QueryExecution?.Status?.State === 'FAILED') {
      throw new Error(`Query failed: ${status.QueryExecution.Status.StateChangeReason}`);
    }

    await new Promise(resolve => setTimeout(resolve, 1000));
    attempts++;
  }

  throw new Error('Query execution timeout');
}

export const handler = async (event: any) => {
  const result = await querySalesHistory('handbags', 500, 2000);
  return {
    statusCode: 200,
    body: JSON.stringify(result)
  };
};
```

## Performance Tuning

### Query Optimization Techniques

1. **Partition Pruning**
   ```sql
   -- Always filter by year, month
   WHERE year = 2024 AND month >= 9
   ```

2. **Column Selection**
   ```sql
   -- Select only needed columns, not *
   SELECT product_id, brand, sold_price
   -- Reduces I/O by 50-80%
   ```

3. **Predicate Pushdown**
   ```sql
   -- Filter early
   WHERE sold_price > 1000
   -- Reduces rows before aggregation
   ```

4. **Data Sampling**
   ```sql
   -- For exploratory queries
   SELECT * FROM sales_history TABLESAMPLE BERNOULLI (10)
   -- Samples 10% of data
   ```

### Monitoring and Metrics

```python
import boto3

cloudwatch = boto3.client('cloudwatch', region_name='eu-west-1')

# Put custom metric
cloudwatch.put_metric_data(
    Namespace='PricingIntelligence',
    MetricData=[
        {
            'MetricName': 'AthenaQueryExecutionTime',
            'Value': 2.5,  # seconds
            'Unit': 'Seconds'
        },
        {
            'MetricName': 'AthenaDataScanned',
            'Value': 2147483648,  # bytes
            'Unit': 'Bytes'
        }
    ]
)
```

## Troubleshooting Guide

### Common Errors and Solutions

#### Error: "HIVE_UNSUPPORTED_FORMAT"
```
Cause: Incorrect file format or encoding
Solution: Verify files are valid Parquet with correct compression
```

#### Error: "GENERIC_INTERNAL_ERROR"
```
Cause: Data corruption or schema mismatch
Solution: Validate data types, re-upload clean data
```

#### Error: "INVALID_COLUMN_SPECIFICATION"
```
Cause: Column name doesn't exist
Solution: Check schema, use DESCRIBE TABLE to list columns
```

#### Error: "HIVE_PARTITION_SCHEMA_MISMATCH"
```
Cause: Partition keys don't match table schema
Solution: Verify year/month columns in partition path
```

## Security Best Practices

1. **Access Control**
   - Use IAM roles, not keys
   - Principle of least privilege
   - Regular permission audits

2. **Data Encryption**
   - S3 encryption at rest (enabled by default)
   - HTTPS for data in transit
   - KMS key rotation

3. **Audit Logging**
   - Enable CloudTrail for Glue changes
   - Enable S3 access logging
   - Monitor Athena query logs

4. **Data Privacy**
   - Filter by tenant_id in all queries
   - Redact sensitive data in results
   - Implement row-level security

## Cost Optimization

### Cost Factors
- **Glue Catalog:** $1.00/month (fixed)
- **Athena Queries:** $5.00 per TB scanned
- **S3 Storage:** $0.023 per GB/month
- **Data Transfer:** Free within region

### Optimization Tips

```python
# 1. Use EXPLAIN to check data scanned
EXPLAIN SELECT * FROM table WHERE ...

# 2. Monitor query costs
SELECT COUNT(*) FROM table
-- Cheaper than SELECT * to estimate size

# 3. Partition by high-cardinality column first
-- Instead of: PARTITION BY (month, category)
-- Use: PARTITION BY (category, month)

# 4. Archive old data
SELECT COUNT(*) FROM table WHERE year < 2023
# Migrate to Glacier
```

## Advanced Topics

### Iceberg Time Travel

```sql
-- View table history
SELECT * FROM "pricing_intelligence_dev"."sales_history$history"
ORDER BY committed_at DESC;

-- Query historical version (EXPERIMENTAL)
SELECT * FROM "pricing_intelligence_dev"."sales_history"
FOR SYSTEM_TIME AS OF timestamp '2024-01-15 10:00:00';
```

### Schema Evolution

```python
# Add new column (Iceberg supports this)
glue.update_table(
    DatabaseName='pricing_intelligence_dev',
    TableInput={
        'Name': 'sales_history',
        'StorageDescriptor': {
            'Columns': [
                # ... existing columns ...
                {
                    'Name': 'new_column',
                    'Type': 'string',
                    'Comment': 'New column description'
                }
            ]
        }
    }
)
```

### Multi-Tenant Optimization

```sql
-- Current partitioning: (year, month)
-- For multi-tenant optimization, consider:
-- PARTITIONED BY (tenant_id, year, month)

-- This allows:
-- 1. Tenant-specific data isolation
-- 2. Faster per-tenant queries
-- 3. Per-tenant retention policies

-- Query pattern
SELECT * FROM sales_history
WHERE tenant_id = 'carousel-labs'
  AND year = 2024
  AND month >= 9
```

## Reference Links

- [Apache Iceberg Docs](https://iceberg.apache.org/)
- [AWS Glue Iceberg](https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-etl-libraries-aws-glue-sql.html)
- [Athena Iceberg Support](https://docs.aws.amazon.com/athena/latest/ug/querying-iceberg-open-table-formats.html)
- [S3 Pricing](https://aws.amazon.com/s3/pricing/)
- [Athena Pricing](https://aws.amazon.com/athena/pricing/)

---

**Last Updated:** 2025-12-30
**Version:** 1.0
**Status:** Production Ready
