{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "metrics": [
          [ "bg-remover/cache", "CacheWriteSuccess", { "stat": "Sum", "label": "L2 Write Success" } ],
          [ ".", "CacheWriteFailure", { "stat": "Sum", "label": "L2 Write Failure" } ],
          [ ".", "CacheWriteException", { "stat": "Sum", "label": "L2 Write Exception" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "eu-west-1",
        "title": "Cache Write Operations",
        "period": 300,
        "yAxis": {
          "left": {
            "label": "Count",
            "showUnits": false
          }
        }
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          [ { "expression": "m1 / (m1 + m2) * 100", "label": "Write Success Rate (%)", "id": "e1" } ],
          [ "bg-remover/cache", "CacheWriteSuccess", { "id": "m1", "visible": false } ],
          [ ".", "CacheWriteFailure", { "id": "m2", "visible": false } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "eu-west-1",
        "title": "Cache Write Success Rate",
        "period": 300,
        "yAxis": {
          "left": {
            "min": 0,
            "max": 100,
            "label": "Percentage",
            "showUnits": false
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "Target",
              "value": 95
            }
          ]
        }
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          [ "bg-remover/cache", "CacheWriteSuccess", { "stat": "Sum", "label": "carousel-labs", "dimensions": { "tenant": "carousel-labs", "layer": "L2" } } ],
          [ "...", { "dimensions": { "tenant": "hringekjan", "layer": "L2" }, "label": "hringekjan" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "eu-west-1",
        "title": "Cache Writes by Tenant",
        "period": 300,
        "yAxis": {
          "left": {
            "label": "Count",
            "showUnits": false
          }
        }
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          [ "bg-remover/cache", "CacheWriteFailure", { "stat": "Sum", "label": "carousel-labs", "dimensions": { "tenant": "carousel-labs", "layer": "L2" } } ],
          [ "...", { "dimensions": { "tenant": "hringekjan", "layer": "L2" }, "label": "hringekjan" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "eu-west-1",
        "title": "Cache Failures by Tenant",
        "period": 300,
        "yAxis": {
          "left": {
            "label": "Count",
            "showUnits": false
          }
        }
      }
    },
    {
      "type": "log",
      "properties": {
        "query": "SOURCE '/aws/lambda/bg-remover-dev-health'\n| fields @timestamp, message\n| filter service = \"cache\" and message like /Circuit breaker/\n| sort @timestamp desc\n| limit 20",
        "region": "eu-west-1",
        "stacked": false,
        "title": "Circuit Breaker State Changes",
        "view": "table"
      }
    },
    {
      "type": "log",
      "properties": {
        "query": "SOURCE '/aws/lambda/bg-remover-dev-health'\n| fields @timestamp, message, key, tenant, layer\n| filter service = \"cache\" and message like /Evicted LRU cache entry/\n| stats count() as evictions by bin(5m)\n| sort @timestamp desc",
        "region": "eu-west-1",
        "stacked": false,
        "title": "Memory Cache Evictions (5min bins)",
        "view": "timeSeries"
      }
    },
    {
      "type": "log",
      "properties": {
        "query": "SOURCE '/aws/lambda/bg-remover-dev-health'\n| fields @timestamp, details.tenantManagers as tenantManagers, details.cacheServiceAvailable as available, details.circuitBreakerState as state\n| filter checks.name = \"cache\"\n| sort @timestamp desc\n| limit 1",
        "region": "eu-west-1",
        "stacked": false,
        "title": "Current Cache Status",
        "view": "table"
      }
    },
    {
      "type": "log",
      "properties": {
        "query": "SOURCE '/aws/lambda/bg-remover-dev-process'\n| fields @timestamp, message, error\n| filter service = \"cache\" and level = \"error\"\n| sort @timestamp desc\n| limit 50",
        "region": "eu-west-1",
        "stacked": false,
        "title": "Cache Errors (Last 50)",
        "view": "table"
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          [ "AWS/Lambda", "Duration", { "stat": "Average", "label": "Avg Duration" } ],
          [ "...", { "stat": "p99", "label": "p99 Duration" } ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "eu-west-1",
        "title": "Lambda Performance (with caching)",
        "period": 300,
        "yAxis": {
          "left": {
            "label": "Milliseconds",
            "showUnits": false
          }
        }
      }
    },
    {
      "type": "log",
      "properties": {
        "query": "SOURCE '/aws/lambda/bg-remover-dev-process'\n| fields @timestamp, tenant, layer, CacheWriteSuccess, CacheWriteFailure\n| filter service = \"cache\"\n| stats sum(CacheWriteSuccess) as successes, sum(CacheWriteFailure) as failures by tenant, layer\n| sort successes desc",
        "region": "eu-west-1",
        "stacked": false,
        "title": "Cache Write Statistics by Tenant",
        "view": "table"
      }
    }
  ]
}
