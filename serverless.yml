service: bg-remover

frameworkVersion: '4'

# Plugins for Python Lambda support
plugins:
  - serverless-python-requirements

# No extends, manually merge base.yml properties

provider:
  name: aws
  runtime: nodejs22.x # User requested Node 22, overrides base.yml's nodejs20.x
  region: eu-west-1 # Inherited from base.yml, can be overridden by env:AWS_REGION
  stage: ${opt:stage, 'dev'} # Inherited from base.yml
  architecture: arm64
  memorySize: 1536 # Overridden for Next.js app needs
  timeout: 60      # Overridden for Next.js app needs
  logs:
    httpApi: false # Disabled as HTTP API is externally configured
  httpApi:
    id: ${ssm:/tf/${sls:stage}/platform/api-gateway/id} # Kept from original
  environment:
    STAGE: ${self:provider.stage} # From original
    NODE_OPTIONS: '--enable-source-maps --expose-gc' # From original

    # DynamoDB Single Table (jobs + rate limits)
    # Single-table design with pk/sk for multi-tenant isolation
    BG_REMOVER_TABLE_NAME: ${self:service}-${self:provider.stage}

    # Cognito JWT Authentication Configuration
    COGNITO_USER_POOL_ID: ${ssm:/tf/${sls:stage}/platform/cognito/user-pool-id}
    COGNITO_ISSUER_URL: ${ssm:/tf/${sls:stage}/platform/cognito/issuer-url}
    REQUIRE_AUTH: 'true'  # Authentication required for all environments
    LOG_LEVEL: DEBUG  # Enable detailed logging for diagnosis

    # Credits Service Integration
    # Uses shared HTTP API Gateway for credits service communication
    CREDITS_API_URL: https://api.${sls:stage}.carousellabs.co/carousel/credits
    REQUIRE_CREDITS: ${env:REQUIRE_CREDITS, 'false'}  # Set to 'true' for production

    # Mem0 Service Integration (for classification memories)
    # Uses shared HTTP API Gateway with IAM authentication
    MEM0_API_ENDPOINT: https://api.${sls:stage}.carousellabs.co/mem0
    TENANT: ${env:TENANT, 'carousel-labs'}

    # Cache Service Integration (distributed L2 cache)
    # Uses shared HTTP API Gateway for cross-Lambda caching
    CACHE_SERVICE_URL: https://api.${sls:stage}.carousellabs.co/cache

    # Cache Key Secret (HMAC for secure cache key generation)
    # CRITICAL: Prevents cache poisoning attacks by using HMAC instead of plain SHA-256
    # Loaded from tenant-specific SecureString SSM parameter (auto-decrypted)
    CACHE_KEY_SECRET: ${ssm:/tf/${sls:stage}/${env:TENANT, 'carousel-labs'}/services/bg-remover/cache-key-secret}

    # Worker Lambda Function Name (for async job pattern)
    WORKER_FUNCTION_NAME: ${self:service}-${self:provider.stage}-processWorker

    # Temporary S3 Bucket for image storage (solves Lambda 1MB payload limit)
    TEMP_IMAGES_BUCKET: bg-remover-temp-images-${self:provider.stage}

    # Embedding Storage Service Configuration
    # Batch-based S3 GetObject calls for improved performance
    EMBEDDINGS_BUCKET: ${env:EMBEDDINGS_BUCKET, 'bg-remover-embeddings-${self:provider.stage}'}
    EMBEDDINGS_BATCH_SIZE: '10'           # Keys per batch request
    EMBEDDINGS_MAX_CONCURRENT: '5'        # Max parallel batch requests
    EMBEDDINGS_RETRY_ATTEMPTS: '3'        # Retry failed S3 calls
    EMBEDDINGS_RETRY_DELAY_MS: '1000'     # Initial retry delay
  iam:
    role:
      statements:
        # SSM Parameter Access - Platform config + All tenant configs (from original)
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource:
            - "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${self:provider.stage}/platform/bg-remover/*"
            - "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${self:provider.stage}/*/services/bg-remover/*"
        # From base.yml (for generic SSM access)
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${sls:stage}/*"
        # Allow writing settings parameter (for persistent similarity detection config)
        - Effect: Allow
          Action:
            - ssm:PutParameter
          Resource:
            - "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${self:provider.stage}/*/services/bg-remover/settings"
            - "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${self:provider.stage}/*/api-keys/carousel"
        - Effect: Deny # From base.yml
          Action:
            - ssm:PutParameter
          Resource: "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${sls:stage}/${env:TENANT, 'carousel-labs'}/services/${self:service}/secrets"
        # Bedrock Nova Lite permissions - RESTRICTED to Nova Lite model only
        # Security: Prevents access to all other foundation models (security violation, cost risk)
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - "arn:aws:bedrock:${aws:region}::foundation-model/us.amazon.nova-lite-v1:0"
        # S3 access for processed image storage
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:PutObjectAcl
            - s3:DeleteObject  # Required for lifecycle policy execution
          Resource:
            - "arn:aws:s3:::bg-remover-*/*"  # Default bucket pattern
            - "arn:aws:s3:::*/${env:TENANT, 'carousel-labs'}/products/*"  # Tenant-specific paths
        # API Gateway IAM auth for service-to-service calls (cache, mem0, credits, carousel-api)
        - Effect: Allow
          Action:
            - execute-api:Invoke
          Resource:
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/GET/cache/*"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/POST/cache/*"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/DELETE/cache/*"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/POST/mem0/*"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/POST/carousel/credits/*"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/GET/carousel/credits/*"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/POST/carousel-api/products"
            - "arn:aws:execute-api:${aws:region}:${aws:accountId}:*/*/GET/carousel-api/products/*"
        # Rekognition for image classification
        - Effect: Allow
          Action:
            - rekognition:DetectLabels
          Resource: "*"
        # EventBridge for emitting CarouselImageProcessed events
        - Effect: Allow
          Action:
            - events:PutEvents
          Resource:
            - "arn:aws:events:${aws:region}:${aws:accountId}:event-bus/default"
        # DynamoDB Single Table permissions (jobs + rate limits)
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
          Resource:
            - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}"
            - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}/index/*"
        # Lambda Invoke permissions (for async job pattern)
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${self:provider.stage}-processWorker"

        # S3 Tables / Glue permissions (Apache Iceberg)
        - Effect: Allow
          Action:
            - glue:CreateDatabase
            - glue:GetDatabase
            - glue:UpdateDatabase
            - glue:CreateTable
            - glue:GetTable
            - glue:UpdateTable
            - glue:DeleteTable
            - glue:BatchCreatePartition
            - glue:BatchDeletePartition
          Resource:
            - "arn:aws:glue:${aws:region}:${aws:accountId}:catalog"
            - "arn:aws:glue:${aws:region}:${aws:accountId}:database/pricing_intelligence_*"
            - "arn:aws:glue:${aws:region}:${aws:accountId}:table/pricing_intelligence_*/sales_history"
            - "arn:aws:glue:${aws:region}:${aws:accountId}:table/pricing_intelligence_*/*"

        # S3 access for Iceberg table storage and analytics
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:GetBucketVersioning
            - s3:GetObjectVersion
          Resource:
            - "arn:aws:s3:::carousel-${sls:stage}-analytics"
            - "arn:aws:s3:::carousel-${sls:stage}-analytics/*"
            - "arn:aws:s3:::carousel-${sls:stage}-analytics/pricing-intelligence/*"
            - "arn:aws:s3:::carousel-${sls:stage}-analytics/athena-results/*"

        # Athena permissions for querying Iceberg tables
        - Effect: Allow
          Action:
            - athena:StartQueryExecution
            - athena:GetQueryExecution
            - athena:GetQueryResults
            - athena:StopQueryExecution
            - athena:GetWorkGroup
          Resource:
            - "arn:aws:athena:${aws:region}:${aws:accountId}:workgroup/primary"

package:
  individually: true
  patterns:
    - '!**'
    - 'dist/**' # Include all compiled files from the dist directory
    - 'src/lib/**' # Include library source files
    - 'src/handlers/**' # Include handler source files
    - 'node_modules/zod/**' # Include zod dependency
    - 'node_modules/jose/**' # Include jose for JWT validation
    - 'node_modules/redis/**' # Include redis for cache-manager
    - '!node_modules/@aws-sdk/**' # Exclude AWS SDK (bundled in Lambda runtime)
    - 'classifier_handler.py' # Include Python classifier handler


custom:
  serviceId: bg-remover
  tags: # From base.yml
    project: ${env:PROJECT, 'carousellabs'}
    service: ${self:service}
    stage: ${sls:stage}

  # Python requirements plugin configuration
  pythonRequirements:
    dockerizePip: false  # Use local pip (faster for simple dependencies)
    slim: true           # Remove unnecessary files to reduce package size
    strip: false         # Keep debugging symbols
    layer: false         # Package with function (not as layer)
    zip: true            # Zip the requirements
    pythonBin: python3.11  # Match Lambda runtime

# Define Next.js API routes as individual Lambda functions
# Assuming `npm run build:handler` generates dist/handler.js for these.
functions:
  health:
    handler: src/handler.health
    description: Health check endpoint (forced redeploy path fix)
    memorySize: 512 # Standard Lambda memory
    timeout: 30     # Standard Lambda timeout
    events:
      - httpApi:
          path: /bg-remover/health
          method: ANY

  process:
    handler: src/handler.process
    description: Accept image processing jobs (async coordinator)
    memorySize: 512  # Lightweight coordinator
    timeout: 30      # Quick response, no processing
    events:
      - httpApi:
          path: /bg-remover/process
          method: POST
      - httpApi:
          path: /bg-remover/process
          method: OPTIONS

  processWorker:
    handler: src/handlers/process-worker-handler.processWorker
    description: Background worker for async image processing
    memorySize: 1536 # Increased memory for image processing
    timeout: 900     # 15 minutes for long-running processing
    reservedConcurrency: 10 # Limit concurrent workers to control costs

  status:
    handler: src/handler.status
    description: Get job status by ID or cancel job
    memorySize: 512
    timeout: 30
    events:
      - httpApi:
          path: /bg-remover/status/{jobId}
          method: GET
      - httpApi:
          path: /bg-remover/status/{jobId}
          method: DELETE
      - httpApi:
          path: /bg-remover/status/{jobId}
          method: OPTIONS

  settings:
    handler: src/handler.settings
    description: Get and update similarity detection settings
    memorySize: 512
    timeout: 30
    events:
      - httpApi:
          path: /bg-remover/settings
          method: GET
      - httpApi:
          path: /bg-remover/settings
          method: PUT
      - httpApi:
          path: /bg-remover/settings
          method: OPTIONS

  createProducts:
    handler: src/handlers/create-products-handler.createProducts
    description: Process image groups and create products in carousel-api
    memorySize: 3008  # High memory for parallel image processing
    timeout: 300      # 5 minutes for processing multiple groups
    events:
      - httpApi:
          path: /bg-remover/create-products
          method: POST
      - httpApi:
          path: /bg-remover/create-products
          method: OPTIONS

  groupImages:
    handler: src/handlers/group-images-handler.groupImages
    description: Group uploaded images by similarity using thumbnails (Phase 1)
    memorySize: 1536  # Medium memory for batch thumbnail generation + embeddings
    timeout: 180      # 3 minutes for processing up to 100 images
    events:
      - httpApi:
          path: /bg-remover/group-images
          method: POST
      - httpApi:
          path: /bg-remover/group-images
          method: OPTIONS

  processGroups:
    handler: src/handlers/process-groups-handler.processGroups
    description: Process approved image groups using agentic pipelines (Phase 3)
    memorySize: 512  # Lightweight coordinator - actual processing in worker
    timeout: 30      # Quick response - async worker invocation
    events:
      - httpApi:
          path: /bg-remover/process-groups
          method: POST
      - httpApi:
          path: /bg-remover/process-groups
          method: OPTIONS

  # COMMENTED OUT - API Gateway route limit reached
  # pricingSuggestion:
  #   handler: src/handlers/pricing-handler.handler
  #   description: Generate pricing suggestions using visual similarity and embedding cache
  #   memorySize: 1024  # Sufficient for 100 embeddings Ã— 4KB = 400KB cache + operations
  #   timeout: 30       # Quick response for pricing endpoint
  #   ephemeralStorageSize: 512  # 512MB /tmp storage for cache (default)
  #   environment:
  #     EMBEDDINGS_BUCKET: ${env:EMBEDDINGS_BUCKET, 'embeddings-bucket'}
  #     CACHE_MAX_SIZE_BYTES: "419430400"  # 400MB
  #     CACHE_TTL_MS: "300000"             # 5 minutes
  #     SALES_TABLE_NAME: ${env:SALES_TABLE_NAME, 'sales-records'}
  #     STAGE: ${self:provider.stage}
  #   events:
  #     - httpApi:
  #         path: /bg-remover/pricing/suggest
  #         method: POST

  # pricingHealth:
  #   handler: src/handlers/pricing-handler.healthHandler
  #   description: Health check for pricing service
  #   memorySize: 512
  #   timeout: 10
  #   environment:
  #     EMBEDDINGS_BUCKET: ${env:EMBEDDINGS_BUCKET, 'embeddings-bucket'}
  #     STAGE: ${self:provider.stage}
  #   events:
  #     - httpApi:
  #         path: /bg-remover/pricing/health
  #         method: GET

  pricingInsightAggregator:
    handler: src/handlers/pricing-insight-aggregator.handler
    description: Weekly batch job to detect seasonal patterns and store in mem0
    memorySize: 1024  # Sufficient for batch analysis
    timeout: 900      # 15 minutes for weekly aggregation
    environment:
      TENANT_ID: ${env:TENANT, 'carousel-labs'}
      STAGE: ${self:provider.stage}
      SALES_TABLE_NAME: ${self:service}-${self:provider.stage}-sales-intelligence
      MEM0_API_URL: ${ssm:/tf/${self:provider.stage}/platform/mem0/api-url, ''}
      MEM0_API_KEY: ${ssm:/tf/${self:provider.stage}/${env:TENANT, 'carousel-labs'}/services/bg-remover/mem0-api-key, ''}
    events:
      - schedule: cron(0 2 ? * SUN *)  # Every Sunday at 2 AM UTC
        name: ${self:service}-${self:provider.stage}-weekly-pricing-insights
        description: Weekly seasonal pattern analysis
        enabled: true
    # Add DynamoDB read permissions for sales intelligence table
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
        Resource:
          - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}-sales-intelligence"
          - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}-sales-intelligence/index/*"

  rotateKeys:
    handler: src/handlers/rotate-keys-handler.rotateKeys
    description: Automated API key rotation for security
    memorySize: 512
    timeout: 30
    events:
      - schedule:
          rate: rate(30 days)  # Rotate keys every 30 days
          enabled: true
    environment:
      TENANT: ${env:TENANT, 'carousel-labs'}

  s3TablesDataValidator:
    handler: src/handlers/s3-tables-data-validator.handler
    description: Daily data quality validation for S3 Tables sync consistency
    memorySize: 1024
    timeout: 900  # 15 minutes for Athena queries
    environment:
      STAGE: ${self:provider.stage}
      TENANT: ${env:TENANT, 'carousel-labs'}
      SALES_TABLE_NAME: ${self:service}-${self:provider.stage}-sales-intelligence
      ALERT_TOPIC_ARN: !Ref DataValidationAlertTopic
    events:
      - schedule:
          rate: cron(0 4 * * ? *)  # Daily at 4 AM UTC
          description: Daily S3 Tables data validation
          enabled: true
    iamRoleStatements:
      # Athena permissions
      - Effect: Allow
        Action:
          - athena:StartQueryExecution
          - athena:GetQueryExecution
          - athena:GetQueryResults
          - athena:GetWorkGroup
        Resource: "*"
      # S3 permissions for Athena results
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
        Resource:
          - "arn:aws:s3:::carousel-${self:provider.stage}-athena-results/*"
      # DynamoDB query permissions for data validation
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource:
          - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}-sales-intelligence"
          - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}-sales-intelligence/index/*"
      # SNS publish permissions for alerts
      - Effect: Allow
        Action:
          - sns:Publish
        Resource:
          - !Ref DataValidationAlertTopic

  smartgoToS3Exporter:
    handler: dist/handlers/smartgo-to-s3-exporter.handler
    description: Daily batch export of SmartGo sales to S3 Tables with Titan embeddings
    memorySize: 1024
    timeout: 900  # 15 minutes for batch processing
    environment:
      STAGE: ${self:provider.stage}
      TENANT: ${env:TENANT, 'carousel-labs'}
      EXPORT_PROGRESS_TABLE_NAME: ${self:service}-${self:provider.stage}-smartgo-export-progress
    events:
      - schedule:
          rate: cron(0 3 * * ? *)  # Daily at 3 AM UTC
          description: Daily SmartGo sales export to S3 Tables
          enabled: true
    iamRoleStatements:
      # SSM Parameter Store access for SmartGo database configuration
      - Effect: Allow
        Action:
          - ssm:GetParameter
          - ssm:GetParameters
        Resource:
          - "arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/tf/${self:provider.stage}/smartgo/database/*"
      # Bedrock Titan Embeddings (us-east-1 only)
      - Effect: Allow
        Action:
          - bedrock:InvokeModel
        Resource:
          - "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-image-v1"
      # S3 access for analytics bucket
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
        Resource:
          - "arn:aws:s3:::carousel-${self:provider.stage}-analytics/pricing-intelligence/smartgo_sales/*"
          - "arn:aws:s3:::carousel-${self:provider.stage}-analytics/images/smartgo/*"
      # DynamoDB access for progress tracking
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:Query
        Resource:
          - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}-smartgo-export-progress"
          - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:service}-${self:provider.stage}-smartgo-export-progress/index/*"

  classifier:
    handler: classifier_handler.handle
    runtime: python3.11
    description: Classify processed images and store memories in mem0
    memorySize: 512
    timeout: 30
    events:
      - eventBridge:
          pattern:
            source:
              - carousel.bg-remover
            detail-type:
              - CarouselImageProcessed

  carouselToS3TablesSync:
    handler: dist/handlers/carousel-to-s3-tables-sync.handler
    description: Real-time sync from Carousel EventBridge events to S3 Tables + DynamoDB
    memorySize: 512
    timeout: 60
    environment:
      STAGE: ${sls:stage}
      TENANT: ${env:TENANT, 'carousel-labs'}
      SALES_TABLE_NAME: ${self:service}-${self:provider.stage}-sales-intelligence
      IDEMPOTENCY_TABLE_NAME: pricing-idempotency-${sls:stage}
      ANALYTICS_BUCKET: carousel-${sls:stage}-analytics
    events:
      - eventBridge:
          pattern:
            source:
              - carousel.products
            detail-type:
              - carousel.product.sold
          retryPolicy:
            maximumRetryAttempts: 3
            maximumEventAge: 3600
          deadLetterConfig:
            arn: !GetAtt CarouselSyncDLQ.Arn
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
        Resource:
          - !GetAtt SalesHistoryTable.Arn
          - !GetAtt IdempotencyTable.Arn
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource:
          - "arn:aws:s3:::carousel-${sls:stage}-analytics/pricing-intelligence/*"
      - Effect: Allow
        Action:
          - events:PutEvents
        Resource:
          - "arn:aws:events:${aws:region}:${aws:accountId}:event-bus/default"

resources:
  Resources:
    # DynamoDB Single Table for jobs + rate limits (multi-tenant design)
    # Key schema:
    #   pk: TENANT#<tenant>#JOB or TENANT#<tenant>#RATELIMIT
    #   sk: JOB#<jobId> or ACTION#<action>#WINDOW#<timestamp>
    # NO GSI needed - pk prefix pattern supports efficient tenant queries
    # Cost optimization: Single table saves ~48% vs separate tables + GSI
    BgRemoverTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Tenant
            Value: ${env:TENANT, 'carousel-labs'}

    # S3 Bucket for temporary image storage (solves Lambda 1MB payload limit)
    # Images auto-deleted after 24 hours via lifecycle policy
    TempImagesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: bg-remover-temp-images-${self:provider.stage}
        LifecycleConfiguration:
          Rules:
            - Id: DeleteAfter24Hours
              Status: Enabled
              ExpirationInDays: 1
              Prefix: temp/
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: temporary-image-storage

    # CloudWatch Alarms for Cache Monitoring
    CacheWriteFailureAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-${env:TENANT, 'carousel-labs'}-cache-write-failures
        AlarmDescription: Alert when cache write failure rate exceeds threshold
        MetricName: CacheWriteFailure
        Namespace: bg-remover/cache
        Statistic: Sum
        Period: 300 # 5 minutes
        EvaluationPeriods: 2
        Threshold: 10 # More than 10 failures in 10 minutes
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        Dimensions:
          - Name: tenant
            Value: ${env:TENANT, 'carousel-labs'}
          - Name: layer
            Value: L2

    CacheWriteExceptionAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-${env:TENANT, 'carousel-labs'}-cache-write-exceptions
        AlarmDescription: Alert on cache write exceptions (network/timeout errors)
        MetricName: CacheWriteException
        Namespace: bg-remover/cache
        Statistic: Sum
        Period: 60 # 1 minute
        EvaluationPeriods: 1
        Threshold: 0
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        Dimensions:
          - Name: tenant
            Value: ${env:TENANT, 'carousel-labs'}
          - Name: layer
            Value: L2

    # SNS Topic for Data Validation Alerts
    # Used by s3TablesDataValidator to send critical issue notifications
    DataValidationAlertTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${self:provider.stage}-data-validation-alerts
        DisplayName: S3 Tables Data Validation Alerts
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: data-quality-monitoring

    # SNS Email Subscription for Data Validation Alerts
    # Sends alerts to ops email when critical data quality issues are detected
    DataValidationAlertSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: email
        TopicArn: !Ref DataValidationAlertTopic
        Endpoint: ${env:ALERT_EMAIL, 'devops@carousellabs.co'}

    # SalesHistoryTable - for pricing intelligence data (Phase 5)
    # Used by carouselToS3TablesSync for dual-write capability
    SalesHistoryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-sales-intelligence
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: pricing-intelligence

    # Idempotency Table - prevents duplicate event processing
    # Used by carouselToS3TablesSync for deduplication
    IdempotencyTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: pricing-idempotency-${sls:stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: event-deduplication

    # SmartGo Export Progress Table - tracks daily export progress
    # Used by smartgoToS3Exporter for observability and monitoring
    SmartGoExportProgressTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-smartgo-export-progress
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: smartgo-export-tracking

    # Dead Letter Queue for carousel sync failures
    CarouselSyncDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: carousel-sync-dlq-${sls:stage}
        MessageRetentionPeriod: 1209600  # 14 days
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: event-dlq

    # S3 Bucket for analytics data lake
    AnalyticsDataLakeBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: carousel-${sls:stage}-analytics
        VersioningConfiguration:
          Status: Enabled
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        LifecycleConfiguration:
          Rules:
            - Id: TransitionToIA
              Status: Enabled
              Transitions:
                - TransitionInDays: 90
                  StorageClass: STANDARD_IA
                - TransitionInDays: 180
                  StorageClass: GLACIER
              NoncurrentVersionTransitions:
                - TransitionInDays: 30
                  StorageClass: STANDARD_IA
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: analytics-data-lake

  extensions: {} # From base.yml