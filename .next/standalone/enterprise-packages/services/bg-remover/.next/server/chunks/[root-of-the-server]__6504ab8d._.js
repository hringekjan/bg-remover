module.exports=[59485,(e,t,a)=>{t.exports=e.x("@aws-sdk/client-s3",()=>require("@aws-sdk/client-s3"))},2606,e=>{"use strict";var t=e.i(25126),a=e.i(4114),r=e.i(74644),s=e.i(44390),n=e.i(63781),o=e.i(51902),i=e.i(69819),l=e.i(86093),u=e.i(65262),c=e.i(42893),d=e.i(7744),p=e.i(89111),g=e.i(97149),m=e.i(32423),h=e.i(7824),f=e.i(12399),w=e.i(93695);e.i(4197);var R=e.i(54566),I=e.i(18531),v=e.i(54799),E=e.i(80736),S=e.i(26522),C=e.i(81732),x=e.i(59485);e.i(63480),e.i(55418),e.i(240),e.i(83692);let T=null;async function b(e,t,a,r="image/png",s={}){let n=function(e="eu-west-1"){return T||(T=new x.S3Client({region:e})),T}();return await n.send(new x.PutObjectCommand({Bucket:e,Key:t,Body:a,ContentType:r,ServerSideEncryption:"AES256",Metadata:{"processed-by":"bg-remover","processed-at":new Date().toISOString(),...s}})),`https://${e}.s3.eu-west-1.amazonaws.com/${t}`}let y=new Map;async function A(e,t,a,r,s){let n=Date.now();try{let o;if(e.imageUrl)o=await (0,C.processImageFromUrl)(e.imageUrl,{format:r,quality:s});else{if(!e.imageBase64)return(0,C.createProcessResult)(!1,void 0,void 0,"No image provided",Date.now()-n);o=await (0,C.processImageFromBase64)(e.imageBase64,"image/png",{format:r,quality:s})}let i=function(e,t,a="png"){let r=Date.now(),s=Math.random().toString(36).substring(2,8);return t?`${e}/products/${t}/processed-${r}-${s}.${a}`:`${e}/processed/${r}-${s}.${a}`}(a,e.productId,r),l="png"===r?"image/png":"webp"===r?"image/webp":"image/jpeg",u=await b(t.s3.outputBucket,i,o.outputBuffer,l,{"original-url":e.imageUrl||"base64-upload","product-id":e.productId||"none",tenant:a,"batch-index":String(e.index)});return{success:!0,jobId:(0,v.randomUUID)(),outputUrl:u,processingTimeMs:Date.now()-n,metadata:o.metadata}}catch(e){return(0,C.createProcessResult)(!1,void 0,void 0,e instanceof Error?e.message:"Processing failed",Date.now()-n)}}async function O(e){let t=Date.now(),a=(0,v.randomUUID)();try{let r=await e.json(),{images:s,outputFormat:n,quality:o,tenant:i,concurrency:l=3}=E.BatchRequestSchema.parse(r);console.log("Starting batch processing",{batchId:a,tenant:i,imageCount:s.length,outputFormat:n,concurrency:l});let u=await (0,S.loadConfig)(i),c={batchId:a,status:"processing",totalImages:s.length,processedImages:0,successfulImages:0,failedImages:0,results:[],startTime:new Date().toISOString()};y.set(a,c);let d=s.map((e,t)=>({index:t,imageUrl:e.url,imageBase64:e.base64,productId:e.productId})),p=[];for(let e=0;e<d.length;e+=l){let t=d.slice(e,e+l),r=await Promise.all(t.map(e=>A(e,u,i,n,o)));p.push(...r),c.processedImages=p.length,c.successfulImages=p.filter(e=>e.success).length,c.failedImages=p.filter(e=>!e.success).length,c.results=p,y.set(a,{...c}),console.log("Batch progress",{batchId:a,processed:p.length,total:d.length,successful:c.successfulImages,failed:c.failedImages})}let g=Date.now()-t,m={...c,status:0===c.failedImages?"completed":0===c.successfulImages?"failed":"partial",results:p,endTime:new Date().toISOString(),processingTimeMs:g};return y.set(a,m),console.log("Batch processing complete",{batchId:a,status:m.status,processingTimeMs:g,successful:m.successfulImages,failed:m.failedImages}),I.NextResponse.json(m)}catch(r){let e=r instanceof Error?r.message:"Unknown error";if(console.error("Batch processing failed",{batchId:a,error:e}),r instanceof Error&&"ZodError"===r.name)return I.NextResponse.json({batchId:a,status:"failed",totalImages:0,processedImages:0,successfulImages:0,failedImages:0,results:[],error:`Validation error: ${e}`,startTime:new Date().toISOString(),endTime:new Date().toISOString(),processingTimeMs:Date.now()-t},{status:400});return I.NextResponse.json({batchId:a,status:"failed",totalImages:0,processedImages:0,successfulImages:0,failedImages:0,results:[],error:e,startTime:new Date().toISOString(),endTime:new Date().toISOString(),processingTimeMs:Date.now()-t},{status:500})}}async function N(e){let{searchParams:t}=new URL(e.url),a=t.get("batchId");if(!a)return I.NextResponse.json({error:"Missing batchId parameter"},{status:400});let r=y.get(a);return r?I.NextResponse.json(r):I.NextResponse.json({error:"Batch not found"},{status:404})}async function D(){return new I.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Tenant-Id"}})}e.s(["GET",()=>N,"OPTIONS",()=>D,"POST",()=>O,"maxDuration",0,300,"runtime",0,"nodejs"],38948);var P=e.i(38948);let U=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/batch/route",pathname:"/api/batch",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/enterprise-packages/services/bg-remover/app/api/batch/route.ts",nextConfigOutput:"standalone",userland:P}),{workAsyncStorage:M,workUnitAsyncStorage:$,serverHooks:_}=U;function k(){return(0,r.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:$})}async function j(e,t,r){U.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let I="/api/batch/route";I=I.replace(/\/index$/,"")||"/";let v=await U.prepare(e,t,{srcPage:I,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:E,params:S,nextConfig:C,parsedUrl:x,isDraftMode:T,prerenderManifest:b,routerServerContext:y,isOnDemandRevalidate:A,revalidateOnlyGenerated:O,resolvedPathname:N,clientReferenceManifest:D,serverActionsManifest:P}=v,M=(0,l.normalizeAppPath)(I),$=!!(b.dynamicRoutes[M]||b.routes[N]),_=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,x,!1):t.end("This page could not be found"),null);if($&&!T){let e=!!b.routes[N],t=b.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await _();throw new w.NoFallbackError}}let k=null;!$||U.isDev||T||(k="/index"===(k=N)?"/":k);let j=!0===U.isDev||!$,B=$&&!j;P&&D&&(0,o.setReferenceManifestsSingleton)({page:I,clientReferenceManifest:D,serverActionsManifest:P,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:P})});let H=e.method||"GET",q=(0,n.getTracer)(),F=q.getActiveScopeSpan(),K={params:S,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>U.onRequestError(e,t,r,y)},sharedContext:{buildId:E}},L=new u.NodeNextRequest(e),G=new u.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(L,(0,c.signalFromNodeResponse)(t));try{let o=async e=>U.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${I}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let u=async({previousCacheEntry:a})=>{try{if(!i&&A&&O&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!$)return await (0,g.sendResponse)(L,G,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:A})},y),t}},c=await U.handleResponse({req:e,nextConfig:C,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:O,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:i});if(!$)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&$||d.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(L,G,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};F?await l(F):await q.withPropagatedContext(e.headers,()=>q.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${I}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:A})}),$)throw t;return await (0,g.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>k,"routeModule",()=>U,"serverHooks",()=>_,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>$],2606)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6504ab8d._.js.map